<!-- app/views/public/movies/show.html.erb -->
<div class="row g-4">
  <!-- Poster -->
  <div class="col-12 col-lg-5">
    <div class="border rounded p-2 bg-white">
      <% if @movie.cover.attached? %>
        <%= image_tag @movie.cover.variant(resize_to_limit: [900, 1300]), class: "img-fluid w-100 rounded" %>
      <% else %>
        <div class="ratio ratio-3x4 bg-light rounded d-flex align-items-center justify-content-center">
          <span class="text-muted">No cover</span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Details -->
  <div class="col-12 col-lg-7">
    <div class="border rounded p-4 bg-white">
      <div class="d-flex align-items-center justify-content-between gap-3">
        <h1 class="h3 mb-0">
          <%= @movie.title %>
          <% if @movie.content_rating.present? %>
            <small class="text-muted">[<%= @movie.content_rating %>]</small>
          <% end %>
        </h1>
        <div class="mb-2">
          <%= render_stars(@movie.average_rating) %>
        </div>
      </div>

      <div class="text-muted mt-1">
        <%= @movie.genres.map(&:name).join(", ") %>
      </div>

      <hr>

      <h6 class="fw-semibold">Description</h6>
      <p class="mb-4"><%= simple_format(@movie.description.presence || "No description.") %></p>

      <div class="row g-4">
        <!-- Cast -->
        <div class="col-sm-6 col-lg-5">
          <div class="bg-light rounded p-3 h-100">
            <div class="fw-semibold mb-2">Cast</div>
            <% if @cast.any? %>
              <ul class="list-unstyled mb-0">
                <% @cast.each do |actor| %>
                  <li><%= actor.try(:first_name).presence || actor.try(:name) || "Unknown" %> <%= actor.try(:last_name) %></li>
                <% end %>
              </ul>
            <% else %>
              <div class="text-muted">No cast listed.</div>
            <% end %>
          </div>
        </div>

        <!-- Meta -->
        <div class="col-sm-6 col-lg-7">
          <div class="bg-light rounded p-3 h-100">
            <div class="row">
              <div class="col-6">
                <div class="fw-semibold">Released</div>
                <div class="text-muted"><%= @movie.released_on&.strftime("%d %b %Y") || "â€”" %></div>
              </div>
              <div class="col-6">
                <div class="fw-semibold">Formats Available</div>
                <div class="text-muted">
                  <% @format_stats.each do |fmt, stats| %>
                    <div><%= fmt %> (<%= stats[:available] %>)</div>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="fw-semibold">Weekly Rental (from)</div>
              <div class="text-muted">
                <% @format_stats.each do |fmt, stats| %>
                  <div><%= fmt %>: <%= currency_from_cents(stats[:price_cents]) %></div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Rent this movie -->
    <h5 class="mt-4">Rent this movie</h5>
    <% @movie.copies.each do |copy| %>
      <div class="d-flex align-items-center gap-3 mb-2">
        <span><strong><%= copy.copy_format %></strong></span>
        <span class="text-muted"><%= number_to_currency(copy.rental_cost/100) %></span>

        <%= form_with url: add_public_cart_path, method: :post, local: true, class: "d-inline-flex gap-2" do %>
          <%= hidden_field_tag :copy_id, copy.id %>
          <%= number_field_tag :quantity, 1, min: 1, class: "form-control", style: "width: 70px" %>
          <%= submit_tag "Add to cart", class: "btn btn-outline-primary btn-sm" %>
        <% end %>
      </div>
    <% end %>

    <!-- Related Videos -->
    <div class="mt-4">
      <h5 class="mb-3">Related Videos</h5>
      <div class="row row-cols-2 row-cols-md-3 g-3">
        <% @recommended.each do |m| %>
          <div class="col">
            <div class="card h-100 shadow-sm">
              <% if m.cover.attached? %>
                <%= link_to image_tag(m.cover.variant(resize_to_limit: [600, 900]), class: "card-img-top"), public_movie_path(m) %>
              <% else %>
                <%= link_to content_tag(:div, "No cover", class: "ratio ratio-2x3 d-flex align-items-center justify-content-center bg-light text-muted"), public_movie_path(m) %>
              <% end %>
              <div class="card-body">
                <div class="fw-semibold"><%= m.title %></div>
                <div class="small text-muted"><%= m.genres.map(&:name).join(", ") %></div>
              </div>
              <div class="card-footer bg-white">
                <%= link_to "View", public_movie_path(m), class: "btn btn-outline-primary btn-sm w-100" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

  </div>
</div>
